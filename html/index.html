<!DOCTYPE html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8" />
  <title>Positionsdaten</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="site.webmanifest" />
  <link rel="apple-touch-icon" href="icon.png" />
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css" />
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />

  <link rel="stylesheet" href="jquery/jquery.mobile-1.4.5.min.css" />


</head>

<body>
  <div id="page" data-role="page" data-theme="b">

    <!------------------------------------Sensordaten----------------- -->
    <div class="header" data-role="header">
      <h1>Sensordaten</h1>
    </div>
    <div class="flex">
      <div class="sensorX">
        <form>
          <h3 for="textfeld1">Sensor 1</h3>
          <input id="textfeld1" readonly />
        </form>
        <label for="dropdown1">Wählen Sie eine Funktion:
          <select name="dropdown1" id="dropdown1" class="dropdown" onchange="hideThings()">
            <option value="linear1">Linear</option>
            <option value="binär1">Binär</option>
            <option value="harfe1">Harfe</option>
          </select>
        </label>
        <fieldset id="schwelle1" class="schwellenwert" style="display:none">
          <label for="groesse1">Schwellenwert:</label>
          <input id="groesse1" type="number" min="0" max="1" step=".05" value=".2" />
        </fieldset>
        <fieldset class="toggle" id="toggle1" style="display:none">
          <label for="flip-1">Wert halten:</label>
          <select onchange="changeTheme()" name="flip-1" id="flip-1" data-role="slider">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </fieldset>
      </div>

      <div class="sensorX">
        <form>
          <h3 for="textfeld2">Sensor 2</h3>
          <input id="textfeld2" readonly />
        </form>
        <label for="dropdown2">Wählen Sie eine Funktion:
          <select name="dropdown2" id="dropdown2" class="dropdown" onchange="hideThings()">
            <option value="linear2">Linear</option>
            <option value="binär2">Binär</option>
            <option value="harfe2">Harfe</option>
          </select>
        </label>
        <fieldset id="schwelle2" class="schwellenwert" style="display:none">
          <label for="groesse2">Schwellenwert:<input id="groesse2" type="number" min="0" max="1" step=".05"
              value=".2" /></label>
        </fieldset>
        <fieldset class="toggle" id="toggle2" style="display:none">
          <label for="flip-2">Wert halten:</label>
          <select name="flip-2" id="flip-2" data-role="slider">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </fieldset>
      </div>

      <div class="sensorX">
        <form>
          <h3 for="textfeld3">Sensor 3</h3>
          <input id="textfeld3" readonly />
        </form>
        <label for="dropdown3">Wählen Sie eine Funktion:
          <select name="dropdown3" id="dropdown3" class="dropdown" onchange="hideThings()">
            <option value="linear3">Linear</option>
            <option value="binär3">Binär</option>
            <option value="harfe3">Harfe</option>
          </select>
        </label>
        <fieldset id="schwelle3" class="schwellenwert" style="display:none">
          <label for="groesse3">Schwellenwert:<input id="groesse3" type="number" min="0" max="1" step=".05"
              value=".2" /></label>
        </fieldset>
        <fieldset class="toggle" id="toggle3" style="display:none">
          <label for="flip-3">Wert halten:</label>
          <select name="flip-3" id="flip-3" data-role="slider">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </fieldset>
      </div>

      <div class="sensorX">
        <form>
          <h3 for="textfeld4">Sensor 4</h3>
          <input id="textfeld4" readonly />
        </form>
        <label for="dropdown4">Wählen Sie eine Funktion:
          <select name="dropdown4" id="dropdown4" class="dropdown" onchange="hideThings()">
            <option value="linear4">Linear</option>
            <option value="binär4">Binär</option>
            <option value="harfe4">Harfe</option>
          </select>
        </label>
        <fieldset id="schwelle4" class="schwellenwert" style="display:none">
          <label for="groesse4">Schwellenwert:<input id="groesse4" type="number" min="0" max="1" step=".05"
              value=".2" /></label>
        </fieldset>
        <fieldset class="toggle" id="toggle4" style="display:none">
          <label for="flip-4">Wert halten:</label>
          <select name="flip-4" id="flip-4" data-role="slider">
            <option value="on">On</option>
            <option value="off">Off</option>
          </select>
        </fieldset>
      </div>
    </div>

    <!------------------------------------Positiontracker----------------- -->
    <div class="tracking">
      <div class="header" data-role="header">
        <h1 class="header">Positionsbestimmung</h1>
      </div>
      <!-- define which picture as floorplan--------type="image/svg+xml"--------- -->
      <div id="svg">
        <object id="dataSVG" data="uploads/Zeichnung.svg" type="image/svg+xml"></object>
      </div>

      <!-- Datei Upload -->
      <div class="upload">
        <form action="upload.php" data-ajax="false" method="post" enctype="multipart/form-data">
          Wählen Sie eine .svg Datei zum Hochladen:
          <input type="file" name="fileToUpload" id="fileToUpload" />
          <input type="submit" value="Hochladen" name="submit" />
        </form>
        <form>
          <label for="whichFile">Welche der hochgeladenen Dateien soll dargestellt werden?:</label><input
            name="whichFile" id="whichFile" />
          <button onclick="changeSVG()" type="button" name="submit1">
            Auswählen
          </button>
        </form>
      </div>
    </div>
  </div>

  <script src="jquery/jquery.js"></script>
  <script src="jquery/jquery.mobile-1.4.5.min.js"></script>
  <script src="js/vendor/modernizr-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script>
    window.jQuery ||
      document.write(
        '<script src="js/vendor/jquery-3.4.1.min.js"><\/script>'
      );
  </script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>
  <script src="js/mqtt.js"></script>

  <script>
    function hideThings() {
      if (document.getElementById("dropdown1").value == "linear1") {
        document.getElementById("schwelle1").style.display = "none";
        document.getElementById("toggle1").style.display = "none";
      }
      if (document.getElementById("dropdown2").value == "linear2") {
        document.getElementById("schwelle2").style.display = "none";
        document.getElementById("toggle2").style.display = "none";
      }
      if (document.getElementById("dropdown3").value == "linear3") {
        document.getElementById("schwelle3").style.display = "none";
        document.getElementById("toggle3").style.display = "none";
      }
      if (document.getElementById("dropdown4").value == "linear4") {
        document.getElementById("schwelle4").style.display = "none";
        document.getElementById("toggle4").style.display = "none";
      }

      if (document.getElementById("dropdown1").value == "binär1" || document.getElementById("dropdown1").value == "harfe1") {
        document.getElementById("schwelle1").style.display = "block";
        document.getElementById("toggle1").style.display = "block";
      }
      if (document.getElementById("dropdown2").value == "binär2" || document.getElementById("dropdown2").value == "harfe2") {
        document.getElementById("schwelle2").style.display = "block";
        document.getElementById("toggle2").style.display = "block";
      }
      if (document.getElementById("dropdown3").value == "binär3" || document.getElementById("dropdown3").value == "harfe3") {
        document.getElementById("schwelle3").style.display = "block";
        document.getElementById("toggle3").style.display = "block";
      }
      if (document.getElementById("dropdown4").value == "binär4" || document.getElementById("dropdown4").value == "harfe4") {
        document.getElementById("schwelle4").style.display = "block";
        document.getElementById("toggle4").style.display = "block";
      }
    }

    function changeSVG() {
      document.getElementById("dataSVG").data = "uploads/" + document.getElementById(
        "whichFile"
      ).value;
    }

    var binary_Val1_t = JSON.stringify({
      Sensor0: 1
    });
    var binary_Val1_f = JSON.stringify({
      Sensor0: 0
    });
    var binary_Val2_t = JSON.stringify({
      Sensor1: 1
    });
    var binary_Val2_f = JSON.stringify({
      Sensor1: 0
    });
    var binary_Val3_t = JSON.stringify({
      Sensor2: 1
    });
    var binary_Val3_f = JSON.stringify({
      Sensor2: 0
    });
    var binary_Val4_t = JSON.stringify({
      Sensor3: 1
    });
    var binary_Val4_f = JSON.stringify({
      Sensor3: 0
    });

    document.getElementById("textfeld1").value = "";
    document.getElementById("textfeld2").value = "";
    document.getElementById("textfeld3").value = "";
    document.getElementById("textfeld4").value = "";

    binarySensor0 = false;
    binarySensor1 = false;
    binarySensor2 = false;
    binarySensor3 = false;
    var lastContact0 = 0;
    var lastContact1 = 0;
    var lastContact2 = 0;
    var lastContact3 = 0;
    var delay = 3000;

    // Create a client instance
    var client = mqtt.connect(
      location.origin.replace(location.protocol, "ws:") + ":15675"
    );
    client.on("connect", function () {
      client.subscribe("lasers/#");
    });
    //what to do when receiving a mqtt message
    client.on("message", function (topic, msg) {
      var x = JSON.parse(msg);
      //--------------------linear and laserx-------------------------------------
      if (
        document.getElementById("dropdown1").value == "linear1" &&
        topic == "lasers/linear/laser0"
      ) {
        document.getElementById("textfeld1").value = x;
        //publish to mqtt topic which sends data via OSC
        client.publish("lasers/OSC/laser0", msg);
      } else if (
        document.getElementById("dropdown2").value == "linear2" &&
        topic == "lasers/linear/laser1"
      ) {
        newtext2 = document.getElementById("textfeld2").value;
        document.getElementById("textfeld2").value = msg;
        client.publish("lasers/OSC/laser1", msg);
      } else if (
        document.getElementById("dropdown3").value == "linear3" &&
        topic == "lasers/linear/laser2"
      ) {
        newtext3 = document.getElementById("textfeld3").value;
        document.getElementById("textfeld3").value = msg;
        client.publish("lasers/OSC/laser2", msg);
      } else if (
        document.getElementById("dropdown4").value == "linear4" &&
        topic == "lasers/linear/laser3"
      ) {
        newtext4 = document.getElementById("textfeld4").value;
        document.getElementById("textfeld4").value = msg;
        client.publish("lasers/OSC/laser3", msg);

        //-------------------------------binary and laserx--------------------------------------------------
      } else if (
        document.getElementById("dropdown1").value == "binär1" &&
        topic == "lasers/linear/laser0"
      ) {
        if (x > document.getElementById("groesse1").value && document.getElementById("flip-1").value == "on") {
          current_time = Date.now();
          if (current_time - lastContact0 > delay) {
            binarySensor0 = !binarySensor0;
            console.log("switch");
          }
          lastContact0 = current_time;
          document.getElementById("textfeld1").value = (binarySensor0 ? "1" : "0");
        } else if (x > document.getElementById("groesse1").value && document.getElementById("flip-1").value == "off") {
          document.getElementById("textfeld1").value = "1";
          client.publish("lasers/OSC/laser0", JSON.stringify({
            Sensor0: 1
          }));
        } else if (x <= document.getElementById("groesse1").value && document.getElementById("flip-1").value == "off") {
          document.getElementById("textfeld1").value = "0";
          client.publish("lasers/OSC/laser0", JSON.stringify({
            Sensor0: 0
          }));
        }
      } else if (
        document.getElementById("dropdown2").value == "binär2" &&
        topic == "lasers/linear/laser1"
      ) {
        if (x > document.getElementById("groesse2").value && document.getElementById("flip-2").value == "on") {
          current_time = Date.now();
          if (current_time - lastContact1 > delay) {
            binarySensor1 = !binarySensor1;
          }
          lastContact1 = current_time;
          document.getElementById("textfeld2").value = (binarySensor1 ? "1" : "0");
        } else if (x > document.getElementById("groesse2").value && document.getElementById("flip-2").value == "off") {
          document.getElementById("textfeld2").value = "1";
          client.publish("lasers/OSC/laser1", JSON.stringify({
            Sensor1: 1
          }));
        } else if (x <= document.getElementById("groesse2").value && document.getElementById("flip-2").value == "off") {
          document.getElementById("textfeld2").value = "0";
          client.publish("lasers/OSC/laser1", JSON.stringify({
            Sensor1: 0
          }));
        }
      } else if (
        document.getElementById("dropdown3").value == "binär3" &&
        topic == "lasers/linear/laser2"
      ) {
        if (x > document.getElementById("groesse3").value && document.getElementById("flip-3").value == "on") {
          current_time = Date.now();
          if (current_time - lastContact2 > delay) {
            binarySensor2 = !binarySensor2;
          }
          lastContact2 = current_time;
          document.getElementById("textfeld3").value = (binarySensor2 ? "1" : "0");
        } else if (x > document.getElementById("groesse3").value) {
          document.getElementById("textfeld3").value = "1";
          client.publish("lasers/OSC/laser2", JSON.stringify({
            Sensor2: 1
          }));
        } else {
          document.getElementById("textfeld3").value = "0";
          client.publish("lasers/OSC/laser2", JSON.stringify({
            Sensor2: 0
          }));
        }
      } else if (
        document.getElementById("dropdown4").value == "binär4" &&
        topic == "lasers/linear/laser3"
      ) {
        if (x > document.getElementById("groesse4").value && document.getElementById("flip-4").value == "on") {
          current_time = Date.now();
          if (current_time - lastContact3 > delay) {
            binarySensor3 = !binarySensor3;
          }
          lastContact3 = current_time;
          document.getElementById("textfeld4").value = (binarySensor3 ? "1" : "0");
        } else if (x > document.getElementById("groesse4").value) {
          document.getElementById("textfeld4").value = "1";
          client.publish("lasers/OSC/laser3", JSON.stringify({
            Sensor3: 1
          }));
        } else {
          document.getElementById("textfeld4").value = "0";
          client.publish("lasers/OSC/laser3", JSON.stringify({
            Sensor3: 0
          }));
        }

        //---------------------------------harfe and laserx----------------------------------------------------
      } else if (
        document.getElementById("dropdown1").value == "harfe1" &&
        topic == "lasers/linear/laser0"
      ) {
        var harfeStufenAnzahl1 = 1 / document.getElementById("groesse1").value;
        for (var i = 0; i < harfeStufenAnzahl1; i++) {
          if (x < document.getElementById("groesse1").value) {
            document.getElementById("textfeld1").value = 0;
            client.publish("lasers/OSC/laser0", JSON.stringify({ Sensor0: 0 }));
            break;
          }
          if (x >= (document.getElementById("groesse1").value * (harfeStufenAnzahl1 - i))) {
            var harfe1 = (document.getElementById("groesse1").value * (harfeStufenAnzahl1 - i)).toFixed(2);
            document.getElementById("textfeld1").value = harfe1;
            client.publish("lasers/OSC/laser0", JSON.stringify({ Sensor0: harfe1 }));
            break;
          }
        }
      } else if (
        document.getElementById("dropdown2").value == "harfe2" &&
        topic == "lasers/linear/laser1"
      ) {
        var harfeStufenAnzahl2 = 1 / document.getElementById("groesse2").value;
        for (var i = 0; i < harfeStufenAnzahl2; i++) {
          if (x >= (document.getElementById("groesse2").value * (harfeStufenAnzahl2 - i))) {
            var harfe2 = (document.getElementById("groesse2").value * (harfeStufenAnzahl2 - i)).toFixed(2);
            document.getElementById("textfeld2").value = harfe2;
            client.publish("lasers/OSC/laser1", JSON.stringify({ Sensor1: harfe2 }));
            break;
          }
        }
      } else if (
        document.getElementById("dropdown3").value == "linear3" &&
        topic == "lasers/linear/laser2"
      ) {
        var harfeStufenAnzahl3 = 1 / document.getElementById("groesse3").value;
        for (var i = 0; i < harfeStufenAnzahl3; i++) {
          if (x >= (document.getElementById("groesse3").value * (harfeStufenAnzahl3 - i))) {
            var harfe3 = (document.getElementById("groesse3").value * (harfeStufenAnzahl3 - i)).toFixed(2);
            document.getElementById("textfeld3").value = harfe3;
            client.publish("lasers/OSC/laser2", JSON.stringify({ Sensor2: harfe3 }));
            break;
          }
        }
      } else if (
        document.getElementById("dropdown4").value == "linear4" &&
        topic == "lasers/linear/laser3"
      ) {
        var harfeStufenAnzahl4 = 1 / document.getElementById("groesse4").value;
        for (var i = 0; i < harfeStufenAnzahl4; i++) {
          if (x >= (document.getElementById("groesse4").value * (harfeStufenAnzahl4 - i))) {
            var harfe4 = (document.getElementById("groesse4").value * (harfeStufenAnzahl4 - i)).toFixed(2);
            document.getElementById("textfeld4").value = harfe4;
            client.publish("lasers/OSC/laser3", JSON.stringify({ Sensor3: harfe4 }));
            break;
          }
        }
      }
    });
  </script>

  <script src="js/spacetracking.js"></script>
</body>

</html>